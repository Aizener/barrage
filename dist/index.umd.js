!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Barrage=e()}(this,function(){"use strict";var l,t;function e(t){this.list=[],this.rId=0,this.isListen=!1,this.listenerTimer=null,this.maxMessage=1500,this.cvs=document.createElement("canvas");t=document.querySelector(t);if(!t)throw new Error("ReferenceError: selector is not exist.");this.target=t,this.init()}return(t=l=l||{})[t.normal=0]="normal",t[t.layer=1]="layer",e.prototype.run=function(){this.handleListenr()},e.prototype.addMessage=function(t){if(!(this.list.length>2*this.maxMessage)){(t="string"==typeof t?{text:t}:t).style||(t.style={}),t.style.fontSize||(t.style.fontSize="20px"),t.style.fontFamily||(t.style.fontFamily="Microsoft YaHei"),t.style.color||(t.style.color="#fff"),t.speed||(t.speed=3);var e={x:0,y:0};t.type===l.layer?(s=t.layerStyle,e.x=s.x,e.y=s.y,e.time=s.time||3e3,e.placement=s.placement):t.type=l.normal;var i=this.getPositoin(t),s=i[0],i=i[1];return this.pushMessage({x:s,y:i,id:String(Math.ceil(1e3*Math.random()))+i+t.speed*i,text:t.text,speed:t.speed,style:t.style,type:t.type,layerStyle:e}),this}},e.prototype.addMessages=function(t){var e=this;return t.forEach(function(t){return e.addMessage(t)}),this},e.prototype.clear=function(){this.list=[],this.ctx.clearRect(0,0,this.cvs.width,this.cvs.height)},e.prototype.stop=function(){this.listenerTimer&&clearInterval(this.listenerTimer),this.listenerTimer=null,this.rId&&cancelAnimationFrame(this.rId)},e.prototype.init=function(){var t=this.target.offsetWidth,e=this.target.offsetHeight;this.cvs.width=t,this.cvs.height=e,this.target.setAttribute("style","position: relative;"),this.cvs.setAttribute("style","position: absolute; pointer-events: none; left: 0; top: 0; z-index: 9999;"),this.ctx=this.cvs.getContext("2d"),this.target.appendChild(this.cvs)},e.prototype.pushMessage=function(t){this.list.push(t)},e.prototype.getPositoin=function(t){var e=0,i=0,s=parseInt(t.style.fontSize);if(t.type===l.normal)e=this.cvs.width,i=Math.random()*(this.cvs.height-s);else if(t.type===l.layer){t=t.layerStyle;if(t.placement)switch(e=Math.ceil(this.cvs.width/2),t.placement){case"top":i=s;break;case"center":i=Math.ceil((this.cvs.height-s)/2);break;case"bottom":i=Math.ceil(this.cvs.height-2*s);break;default:i=Math.ceil(this.cvs.height/2)}else e=t.x,i=t.y}return[Math.floor(e),Math.floor(i)]},e.prototype.handleListenr=function(){var t=this;this.isListen||(this.isListen=!0,this.list.length?this.handleAnimate():this.listenerTimer=setInterval(function(){t.handleAnimate()},1e3))},e.prototype.handleAnimate=function(){0<this.list.length&&(this.rId&&cancelAnimationFrame(this.rId),this.animate(),this.isListen=!1,this.listenerTimer&&clearInterval(this.listenerTimer))},e.prototype.animate=function(){var s=this;if(this.ctx.clearRect(0,0,this.cvs.width,this.cvs.height),!this.list.length)return this.rId&&cancelAnimationFrame(this.rId),void this.handleListenr();for(var t=[],e=0,i=this.list.slice(0,this.maxMessage);e<i.length;e++){var n,r,h,a=i[e];a.type===l.normal&&(a.x-=a.speed),a.x>=this.cvs.width||(h=(r=a.style).color,n=r.fontSize,r=r.fontFamily,this.ctx.beginPath(),this.ctx.font="".concat(n," ").concat(r),this.ctx.fillStyle=h,this.ctx.fillText(a.text,a.x,a.y+parseInt(a.style.fontSize)),a.type===l.normal?(h=this.ctx.measureText(a.text).width,a.x<=-h&&t.push(a.id)):a.type===l.layer&&(t.includes(a.id)||t.push(a.id)))}t.forEach(function(e){var t=s.list.findIndex(function(t){return t.id===e}),i=s.list[t];i.type===l.normal?0<=t&&s.list.splice(t,1):(i=i.layerStyle).removing||(setTimeout(function(){var t=s.list.findIndex(function(t){return t.id===e});0<=t&&s.list.splice(t,1)},i.time),i.removing=!0)}),this.rId=requestAnimationFrame(this.animate.bind(this))},e.normal=l.normal,e.layer=l.layer,e});
